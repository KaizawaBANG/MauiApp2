@page "/sales-history"
@layout MainLayout
@using MauiApp2.Services
@using MauiApp2.Models
@using Microsoft.JSInterop
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject ISalesOrderService SalesOrderService
@inject IJSRuntime JSRuntime

<link href="css/pagination.css" rel="stylesheet" />

<div class="dashboard-wrapper">
    <Sidebar />
    <div class="main-content">
        <div class="content-header">
            <h1>Sales History</h1>
            <p>View and manage sales transaction records</p>
        </div>

        <div class="inventory-section">
            <div class="product-table-container">
                <!-- Alert Messages -->
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-error">
                        <i class="fas fa-exclamation-triangle alert-icon"></i>
                        <span>@errorMessage</span>
                        <button class="alert-close" @onclick="ClearError">×</button>
                    </div>
                }

                <div class="toolbar">
                    <div class="search-container">
                        <input type="text"
                               class="search-input"
                               placeholder="Search by invoice number, payment method..."
                               value="@searchTerm"
                               @oninput="OnSearchInput" />
                        <i class="fas fa-search search-icon"></i>
                    </div>
                </div>

                <table class="product-table">
                    <thead>
                        <tr>
                            <th>Invoice Number</th>
                            <th>Sale Date</th>
                            <th>Items</th>
                            <th>Subtotal</th>
                            <th>Tax</th>
                            <th>Total Amount</th>
                            <th>Customer</th>
                            <th>Payment Method</th>
                            <th>Processed By</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (PaginatedSales.Any())
                        {
                            @foreach (var sale in PaginatedSales)
                            {
                                <tr>
                                    <td>
                                        <span class="invoice-number">@sale.sales_order_number</span>
                                    </td>
                                    <td>@sale.sales_date.ToString("MM/dd/yyyy HH:mm")</td>
                                    <td>@(sale.item_count ?? 0)</td>
                                    <td>₱@sale.subtotal.ToString("N2")</td>
                                    <td>₱@sale.tax_amount.ToString("N2")</td>
                                    <td>
                                        <span class="total-amount">₱@sale.total_amount.ToString("N2")</span>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(sale.customer_name))
                                        {
                                            <span class="customer-name">@sale.customer_name</span>
                                        }
                                        else
                                        {
                                            <span class="no-data">Walk-in Customer</span>
                                        }
                                    </td>
                                    <td>
                                        <span class="payment-badge payment-@sale.payment_method.ToLower().Replace(" ", "-")">
                                            @sale.payment_method
                                        </span>
                                    </td>
                                    <td>@(sale.processed_by_name ?? "N/A")</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="view-btn" title="View Details" @onclick="() => ViewSaleDetails(sale)">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="10" class="no-data">
                                    <i class="fas fa-receipt no-data-icon"></i>
                                    <div class="no-data-text">
                                        @if (string.IsNullOrWhiteSpace(searchTerm))
                                        {
                                            <span>No sales records found.</span>
                                        }
                                        else
                                        {
                                            <span>No sales records match your search criteria.</span>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>

                <!-- Pagination -->
                @if (FilteredSales.Any())
                {
                    <Pagination CurrentPage="@currentPage"
                                PageSize="@pageSize"
                                TotalItems="@FilteredSales.Count()"
                                PageChanged="@OnPageChanged"
                                PageSizeChanged="@OnPageSizeChanged" />
                }
            </div>
        </div>
    </div>
</div>

<!-- View Sale Details Modal -->
@if (showViewDetailsModal && viewingSale != null)
{
    <div class="modal-overlay" @onclick="CloseViewDetailsModal">
        <div class="modal-content large-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Sale Details - @viewingSale.sales_order_number</h3>
                <button class="modal-close" @onclick="CloseViewDetailsModal">×</button>
            </div>
            <div class="modal-body">
                @if (isLoadingDetails)
                {
                    <div class="loading-indicator">
                        <div class="spinner"></div>
                        <span>Loading details...</span>
                    </div>
                }
                else
                {
                    <!-- Customer Information Section -->
                    @if (!string.IsNullOrEmpty(viewingSale.customer_name) || viewingSale.customer_id.HasValue)
                    {
                        <div class="po-details-section">
                            <h4>Customer Information</h4>
                            <div class="po-details-grid">
                                <div class="po-detail-item">
                                    <label>Customer Name:</label>
                                    <span>@(viewingSale.customer_name ?? "N/A")</span>
                                </div>
                                @if (!string.IsNullOrEmpty(viewingSale.customer_contact))
                                {
                                    <div class="po-detail-item">
                                        <label>Contact Number:</label>
                                        <span>@viewingSale.customer_contact</span>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(viewingSale.customer_email))
                                {
                                    <div class="po-detail-item">
                                        <label>Email:</label>
                                        <span>@viewingSale.customer_email</span>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(viewingSale.customer_address))
                                {
                                    <div class="po-detail-item full-width">
                                        <label>Address:</label>
                                        <span>@viewingSale.customer_address</span>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <!-- Sale Information Section -->
                    <div class="po-details-section">
                        <h4>Sale Information</h4>
                        <div class="po-details-grid">
                            <div class="po-detail-item">
                                <label>Invoice Number:</label>
                                <span>@viewingSale.sales_order_number</span>
                            </div>
                            <div class="po-detail-item">
                                <label>Sale Date:</label>
                                <span>@viewingSale.sales_date.ToString("MM/dd/yyyy HH:mm")</span>
                            </div>
                            <div class="po-detail-item">
                                <label>Payment Method:</label>
                                <span>@viewingSale.payment_method</span>
                            </div>
                            <div class="po-detail-item">
                                <label>Processed By:</label>
                                <span>@(viewingSale.processed_by_name ?? "N/A")</span>
                            </div>
                            <div class="po-detail-item">
                                <label>Subtotal:</label>
                                <span>₱@viewingSale.subtotal.ToString("N2")</span>
                            </div>
                            <div class="po-detail-item">
                                <label>Tax Amount:</label>
                                <span>₱@viewingSale.tax_amount.ToString("N2")</span>
                            </div>
                            <div class="po-detail-item full-width">
                                <label>Total Amount:</label>
                                <span class="total-amount">₱@viewingSale.total_amount.ToString("N2")</span>
                            </div>
                        </div>
                    </div>

                    <!-- Items Section -->
                    <div class="po-items-section">
                        <h4>Sale Items</h4>
                        @if (viewingSaleItems.Any())
                        {
                            <table class="po-items-table">
                                <thead>
                                    <tr>
                                        <th>Product Name</th>
                                        <th>SKU</th>
                                        <th>Quantity</th>
                                        <th>Unit Price</th>
                                        <th>Tax Rate</th>
                                        <th>Tax Amount</th>
                                        <th>Subtotal</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in viewingSaleItems)
                                    {
                                        <tr>
                                            <td>@(item.product_name ?? "N/A")</td>
                                            <td>@(item.product_sku ?? "N/A")</td>
                                            <td>@item.quantity</td>
                                            <td>₱@item.unit_price.ToString("N2")</td>
                                            <td>@((item.tax_rate * 100).ToString("N2"))%</td>
                                            <td>₱@item.tax_amount.ToString("N2")</td>
                                            <td>₱@item.subtotal.ToString("N2")</td>
                                            <td>₱@item.total.ToString("N2")</td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="6" style="text-align: right; font-weight: 600;">Grand Total:</td>
                                        <td style="font-weight: 700; font-size: 16px;" colspan="2">₱@viewingSale.total_amount.ToString("N2")</td>
                                    </tr>
                                </tfoot>
                            </table>
                        }
                        else
                        {
                            <div class="no-items">
                                <p>No items found for this sale.</p>
                            </div>
                        }
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" @onclick="CloseViewDetailsModal">Close</button>
            </div>
        </div>
    </div>
}

@code {
    private bool showViewDetailsModal = false;
    private SalesOrder? viewingSale = null;
    private List<SalesOrderItem> viewingSaleItems = new List<SalesOrderItem>();
    private bool isLoadingDetails = false;
    private string errorMessage = "";

    // Filter fields
    private string searchTerm = "";

    // Pagination
    private int currentPage = 1;
    private int pageSize = 10;

    // Data collections
    private List<SalesOrder> allSales = new List<SalesOrder>();

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/");
            return;
        }

        await LoadSales();
    }

    private async Task LoadSales()
    {
        try
        {
            allSales = await SalesOrderService.GetAllSalesOrdersAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading sales: {ex.Message}";
        }
        finally
        {
            StateHasChanged();
        }
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? "";
        currentPage = 1; // Reset to first page when searching
        StateHasChanged();
    }

    private IEnumerable<SalesOrder> FilteredSales
    {
        get
        {
            var filtered = allSales.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                filtered = filtered.Where(s =>
                    s.sales_order_number.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    s.payment_method.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    (s.processed_by_name != null && s.processed_by_name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)));
            }

            return filtered.OrderByDescending(s => s.sales_date);
        }
    }

    private IEnumerable<SalesOrder> PaginatedSales
    {
        get
        {
            var filtered = FilteredSales.ToList();
            return filtered.Skip((currentPage - 1) * pageSize).Take(pageSize);
        }
    }

    private void OnPageChanged(int page)
    {
        currentPage = page;
        StateHasChanged();
    }

    private void OnPageSizeChanged(int newPageSize)
    {
        pageSize = newPageSize;
        currentPage = 1;
        StateHasChanged();
    }

    private async Task ViewSaleDetails(SalesOrder sale)
    {
        try
        {
            showViewDetailsModal = true;
            viewingSale = sale;
            isLoadingDetails = true;
            viewingSaleItems.Clear();
            StateHasChanged();

            var items = await SalesOrderService.GetSalesOrderItemsAsync(sale.sales_order_id);
            viewingSaleItems = items;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading sale details: {ex.Message}";
        }
        finally
        {
            isLoadingDetails = false;
            StateHasChanged();
        }
    }

    private void CloseViewDetailsModal()
    {
        showViewDetailsModal = false;
        viewingSale = null;
        viewingSaleItems.Clear();
        StateHasChanged();
    }

    private void ClearError()
    {
        errorMessage = "";
        StateHasChanged();
    }
}







