@page "/dashboard"
@layout MainLayout
@using MauiApp2.Services
@using MauiApp2.Models
@using System.Linq
@using System
@inject IAuthService AuthService
@inject IUserService UserService
@inject ISalesOrderService SalesOrderService
@inject IPurchaseOrderService PurchaseOrderService
@inject IProductService ProductService
@inject ISupplierService SupplierService
@inject IStockInService StockInService
@inject IStockOutService StockOutService
@inject IExpenseService ExpenseService
@inject IAccountsPayableService AccountsPayableService
@inject NavigationManager Navigation

<link href="css/dashboard.css" rel="stylesheet" />

<div class="dashboard-wrapper">
    <Sidebar />
    <main class="main-content">
        <!-- Header with Dashboard title -->
        <header class="header">
            <h1 class="page-title">Dashboard</h1>
        </header>

        <div class="dashboard-section">
            <!-- Role-Based Dashboard Content -->
            @if (IsAdministrator())
            {
                <!-- Administrator Dashboard - Full Access -->
                <div class="stats-container">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">Total Sales (Today)</span>
                                <div class="stat-icon sales-icon-bg">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                            </div>
                            <div class="stat-value">₱@todaySales.ToString("N2")</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i> @todayTransactions transactions
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">Total Sales (This Month)</span>
                                <div class="stat-icon sales-icon-bg">
                                    <i class="fas fa-chart-bar"></i>
                                </div>
                            </div>
                            <div class="stat-value">₱@monthlySales.ToString("N2")</div>
                            <div class="stat-change positive">
                                @monthlyTransactions transactions
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">Total Products</span>
                                <div class="stat-icon product-icon-bg">
                                    <i class="fas fa-box"></i>
                                </div>
                            </div>
                            <div class="stat-value">@totalProducts.ToString("N0")</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">Pending POs</span>
                                <div class="stat-icon pending-icon-bg">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                            <div class="stat-value">@pendingOrders.ToString("N0")</div>
                            <div class="stat-change neutral">
                                @deliveredOrders delivered this month
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">Total Suppliers</span>
                                <div class="stat-icon supplier-icon-bg">
                                    <i class="fas fa-truck"></i>
                                </div>
                            </div>
                            <div class="stat-value">@totalSuppliers.ToString("N0")</div>
                            <div class="stat-change neutral">
                                @activeSuppliers active
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">Total Users</span>
                                <div class="stat-icon user-icon-bg">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                            <div class="stat-value">@totalUsers.ToString("N0")</div>
                            <div class="stat-change neutral">
                                Active users
                            </div>
                        </div>
                    </div>
                </div>
            }
            else if (IsCashier())
            {
                <!-- Cashier Dashboard - Sales Focused -->
                <div class="stats-container">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">Today's Sales</span>
                                <div class="stat-icon sales-icon-bg">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                            </div>
                            <div class="stat-value">₱@cashierTodaySales.ToString("N2")</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i> @cashierTodayTransactions transactions
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">This Week's Sales</span>
                                <div class="stat-icon sales-icon-bg">
                                    <i class="fas fa-chart-bar"></i>
                                </div>
                            </div>
                            <div class="stat-value">₱@cashierWeeklySales.ToString("N2")</div>
                            <div class="stat-change positive">
                                @cashierWeeklyTransactions transactions
                            </div>
                        </div>
                    </div>
                </div>
            }
            else if (IsInventoryManager())
            {
                <!-- Inventory Manager Dashboard - Inventory Focused -->
                <div class="stats-container">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">Low Stock Products</span>
                                <div class="stat-icon pending-icon-bg">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                            </div>
                            <div class="stat-value">@lowStockProducts</div>
                            <div class="stat-change neutral">
                                Need attention
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">Out of Stock</span>
                                <div class="stat-icon pending-icon-bg">
                                    <i class="fas fa-times-circle"></i>
                                </div>
                            </div>
                            <div class="stat-value">@outOfStockProducts</div>
                            <div class="stat-change negative">
                                Urgent restock needed
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">Today's Stock In</span>
                                <div class="stat-icon product-icon-bg">
                                    <i class="fas fa-arrow-down"></i>
                                </div>
                            </div>
                            <div class="stat-value">@todayStockIn</div>
                            <div class="stat-change neutral">
                                Receipts today
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">Today's Stock Out</span>
                                <div class="stat-icon product-icon-bg">
                                    <i class="fas fa-arrow-up"></i>
                                </div>
                            </div>
                            <div class="stat-value">@todayStockOut</div>
                            <div class="stat-change neutral">
                                Transactions today
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">Pending POs</span>
                                <div class="stat-icon pending-icon-bg">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                            <div class="stat-value">@inventoryPendingPOs</div>
                            <div class="stat-change neutral">
                                Awaiting delivery
                            </div>
                        </div>
                    </div>
                </div>
            }
            else if (IsAccountant())
            {
                <!-- Accountant Dashboard - Financial Focused -->
                <div class="stats-container">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">Total Revenue</span>
                                <div class="stat-icon sales-icon-bg">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                            </div>
                            <div class="stat-value">₱@totalRevenue.ToString("N2")</div>
                            <div class="stat-change positive">
                                All-time sales
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">Total Expenses</span>
                                <div class="stat-icon pending-icon-bg">
                                    <i class="fas fa-receipt"></i>
                                </div>
                            </div>
                            <div class="stat-value">₱@totalExpenses.ToString("N2")</div>
                            <div class="stat-change neutral">
                                All expenses
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">Net Profit</span>
                                <div class="stat-icon sales-icon-bg">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                            </div>
                            <div class="stat-value @(netProfit >= 0 ? "positive" : "negative")">₱@netProfit.ToString("N2")</div>
                            <div class="stat-change @(netProfit >= 0 ? "positive" : "negative")">
                                @(netProfit >= 0 ? "Profit" : "Loss")
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">Accounts Payable</span>
                                <div class="stat-icon pending-icon-bg">
                                    <i class="fas fa-file-invoice-dollar"></i>
                                </div>
                            </div>
                            <div class="stat-value">₱@accountsPayableTotal.ToString("N2")</div>
                            <div class="stat-change neutral">
                                Outstanding payments
                            </div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <!-- Default Dashboard for other roles -->
                <div class="stats-container">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">Welcome</span>
                                <div class="stat-icon sales-icon-bg">
                                    <i class="fas fa-user"></i>
                                </div>
                            </div>
                            <div class="stat-value">@AuthService.CurrentUserName</div>
                            <div class="stat-change neutral">
                                Role: @AuthService.CurrentUserRoleName
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Administrator & Accountant: Sales Analytics Chart -->
            @if (IsAdministrator() || IsAccountant())
            {
                <div class="chart-section">
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title-section">
                                <h2 class="chart-title">Sales Analytics</h2>
                                <p class="chart-subtitle">Monthly revenue performance and trends</p>
                            </div>
                            <div class="chart-controls">
                                <div class="chart-date-controls">
                                    <div class="form-group">
                                        <label>Start Date</label>
                                        <input type="date" class="form-control date-input" value="@chartStartDate.ToString("yyyy-MM-dd")" @onchange="OnStartDateChanged" />
                                    </div>
                                    <div class="form-group">
                                        <label>End Date</label>
                                        <input type="date" class="form-control date-input" value="@chartEndDate.ToString("yyyy-MM-dd")" @onchange="OnEndDateChanged" />
                                    </div>
                                    <div class="form-group">
                                        <label>&nbsp;</label>
                                        <button class="btn-generate" @onclick="LoadChartData">
                                            <i class="fas fa-search"></i> Apply
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="chart-metrics">
                            <div class="metric-card">
                                <div class="metric-value">₱@chartTotalRevenue.ToString("N2")</div>
                                <div class="metric-label">Total Revenue</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">₱@chartAverageDaily.ToString("N2")</div>
                                <div class="metric-label">Average Daily</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">@chartTransactionCount.ToString("N0")</div>
                                <div class="metric-label">Transactions</div>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            @if (chartDataPoints.Any())
                            {
                                <svg viewBox="0 0 1000 450" class="line-chart">
                                    <!-- Grid Lines -->
                                    <line x1="80" y1="50" x2="80" y2="380" stroke="#f0f0f0" stroke-width="1" />
                                    <line x1="80" y1="380" x2="920" y2="380" stroke="#f0f0f0" stroke-width="1" />

                                    @foreach (var gridLine in chartGridLines)
                                    {
                                        var gridY = gridLine.Y;
                                        var gridLabelY = gridY + 5;
                                        <line x1="80" y1="@gridY" x2="920" y2="@gridY" stroke="#f0f0f0" stroke-width="1" stroke-dasharray="3,3" />
                                        @((MarkupString)$"<text x=\"70\" y=\"{gridLabelY}\" font-size=\"12\" fill=\"#666\" text-anchor=\"end\">{gridLine.Label}</text>")
                                    }

                                    <!-- Sales Line -->
                                    @if (chartPathPoints.Any())
                                    {
                                        <polyline points="@string.Join(" ", chartPathPoints)"
                                                  fill="none"
                                                  stroke="#3b82f6"
                                                  stroke-width="3"
                                                  stroke-linecap="round"
                                                  stroke-linejoin="round" />

                                        @foreach (var point in chartPointData)
                                        {
                                            var pointX = point.X;
                                            var pointLabel = point.Label;
                                            <circle cx="@pointX" cy="@point.Y" r="4" fill="#3b82f6" />
                                            @((MarkupString)$"<text x=\"{pointX}\" y=\"400\" font-size=\"11\" fill=\"#666\" text-anchor=\"middle\">{pointLabel}</text>")
                                        }
                                    }
                                </svg>
                            }
                            else
                            {
                                <div class="no-chart-data">
                                    <i class="fas fa-chart-line"></i>
                                    <p>No sales data available for the selected period.</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- Accountant: Revenue vs Expenses Chart -->
            @if (IsAccountant())
            {
                <div class="chart-section">
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title-section">
                                <h2 class="chart-title">Revenue vs Expenses</h2>
                                <p class="chart-subtitle">Monthly comparison of revenue and expenses</p>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            @if (accountantChartData.Any())
                            {
                                <svg viewBox="0 0 1000 450" class="line-chart">
                                    <!-- Grid Lines -->
                                    <line x1="80" y1="50" x2="80" y2="380" stroke="#f0f0f0" stroke-width="1" />
                                    <line x1="80" y1="380" x2="920" y2="380" stroke="#f0f0f0" stroke-width="1" />

                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        var y = 50 + (i * 66);
                                        var labelValue = accountantChartMax * ((decimal)i / 5);
                                        <line x1="80" y1="@y" x2="920" y2="@y" stroke="#f0f0f0" stroke-width="1" stroke-dasharray="3,3" />
                                        @((MarkupString)$"<text x=\"70\" y=\"{y + 5}\" font-size=\"12\" fill=\"#666\" text-anchor=\"end\">₱{(labelValue / 1000):F0}k</text>")
                                    }

                                    <!-- Revenue Line -->
                                    @if (accountantRevenuePoints.Any())
                                    {
                                        <polyline points="@string.Join(" ", accountantRevenuePoints)"
                                                  fill="none"
                                                  stroke="#10b981"
                                                  stroke-width="3"
                                                  stroke-linecap="round"
                                                  stroke-linejoin="round" />
                                    }

                                    <!-- Expenses Line -->
                                    @if (accountantExpensePoints.Any())
                                    {
                                        <polyline points="@string.Join(" ", accountantExpensePoints)"
                                                  fill="none"
                                                  stroke="#ef4444"
                                                  stroke-width="3"
                                                  stroke-linecap="round"
                                                  stroke-linejoin="round" />
                                    }

                                    <!-- Legend -->
                                    <circle cx="100" cy="60" r="5" fill="#10b981" />
                                    @((MarkupString)$"<text x=\"115\" y=\"65\" font-size=\"12\" fill=\"#374151\">Revenue</text>")
                                    <circle cx="200" cy="60" r="5" fill="#ef4444" />
                                    @((MarkupString)$"<text x=\"215\" y=\"65\" font-size=\"12\" fill=\"#374151\">Expenses</text>")

                                    <!-- Date Labels -->
                                    @for (int i = 0; i < accountantChartData.Count; i++)
                                    {
                                        var x = 80 + (i * (840 / Math.Max(1, accountantChartData.Count - 1)));
                                        var label = accountantChartData[i].Date.ToString("MMM");
                                        @((MarkupString)$"<text x=\"{x}\" y=\"400\" font-size=\"11\" fill=\"#666\" text-anchor=\"middle\">{label}</text>")
                                    }
                                </svg>
                            }
                            else
                            {
                                <div class="no-chart-data">
                                    <i class="fas fa-chart-line"></i>
                                    <p>No financial data available.</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- Cashier: Daily Sales Chart -->
            @if (IsCashier())
            {
                <div class="chart-section">
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title-section">
                                <h2 class="chart-title">Daily Sales Trend</h2>
                                <p class="chart-subtitle">Last 7 days sales performance</p>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            @if (cashierDailySalesData.Any())
                            {
                                <svg viewBox="0 0 1000 450" class="line-chart">
                                    <!-- Grid Lines -->
                                    <line x1="80" y1="50" x2="80" y2="380" stroke="#f0f0f0" stroke-width="1" />
                                    <line x1="80" y1="380" x2="920" y2="380" stroke="#f0f0f0" stroke-width="1" />

                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        var y = 50 + (i * 66);
                                        var labelValue = cashierChartMax * ((decimal)i / 5);
                                        <line x1="80" y1="@y" x2="920" y2="@y" stroke="#f0f0f0" stroke-width="1" stroke-dasharray="3,3" />
                                        @((MarkupString)$"<text x=\"70\" y=\"{y + 5}\" font-size=\"12\" fill=\"#666\" text-anchor=\"end\">₱{(labelValue / 1000):F0}k</text>")
                                    }

                                    <!-- Bar Chart for Daily Sales -->
                                    @for (int i = 0; i < cashierDailySalesData.Count; i++)
                                    {
                                        var barWidth = 80;
                                        var spacing = 840.0 / cashierDailySalesData.Count;
                                        var barX = 80 + (i * spacing) + (spacing - barWidth) / 2;
                                        var barHeight = cashierChartMax > 0 ? (cashierDailySalesData[i].Amount / cashierChartMax) * 330 : 0;
                                        var barY = 380 - barHeight;
                                        
                                        <rect x="@barX" y="@barY" width="@barWidth" height="@barHeight" fill="#3b82f6" rx="4" />
                                        @((MarkupString)$"<text x=\"{barX + barWidth / 2}\" y=\"{barY - 10}\" font-size=\"11\" fill=\"#374151\" text-anchor=\"middle\" font-weight=\"600\">₱{(cashierDailySalesData[i].Amount / 1000):F1}k</text>")
                                        @((MarkupString)$"<text x=\"{barX + barWidth / 2}\" y=\"400\" font-size=\"11\" fill=\"#666\" text-anchor=\"middle\">{cashierDailySalesData[i].Date.ToString("ddd")}</text>")
                                    }
                                </svg>
                            }
                            else
                            {
                                <div class="no-chart-data">
                                    <i class="fas fa-chart-bar"></i>
                                    <p>No sales data available for the last 7 days.</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- Inventory Manager: Stock Movement Chart -->
            @if (IsInventoryManager())
            {
                <div class="chart-section">
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title-section">
                                <h2 class="chart-title">Stock Movement Trends</h2>
                                <p class="chart-subtitle">Last 7 days stock in and stock out activity</p>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            @if (inventoryMovementData.Any())
                            {
                                <svg viewBox="0 0 1000 450" class="line-chart">
                                    <!-- Grid Lines -->
                                    <line x1="80" y1="50" x2="80" y2="380" stroke="#f0f0f0" stroke-width="1" />
                                    <line x1="80" y1="380" x2="920" y2="380" stroke="#f0f0f0" stroke-width="1" />

                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        var y = 50 + (i * 66);
                                        var labelValue = inventoryChartMax * (i / 5);
                                        <line x1="80" y1="@y" x2="920" y2="@y" stroke="#f0f0f0" stroke-width="1" stroke-dasharray="3,3" />
                                        @((MarkupString)$"<text x=\"70\" y=\"{y + 5}\" font-size=\"12\" fill=\"#666\" text-anchor=\"end\">{labelValue}</text>")
                                    }

                                    <!-- Stock In Line -->
                                    @if (inventoryStockInPoints.Any())
                                    {
                                        <polyline points="@string.Join(" ", inventoryStockInPoints)"
                                                  fill="none"
                                                  stroke="#10b981"
                                                  stroke-width="3"
                                                  stroke-linecap="round"
                                                  stroke-linejoin="round" />
                                    }

                                    <!-- Stock Out Line -->
                                    @if (inventoryStockOutPoints.Any())
                                    {
                                        <polyline points="@string.Join(" ", inventoryStockOutPoints)"
                                                  fill="none"
                                                  stroke="#ef4444"
                                                  stroke-width="3"
                                                  stroke-linecap="round"
                                                  stroke-linejoin="round" />
                                    }

                                    <!-- Legend -->
                                    <circle cx="100" cy="60" r="5" fill="#10b981" />
                                    @((MarkupString)$"<text x=\"115\" y=\"65\" font-size=\"12\" fill=\"#374151\">Stock In</text>")
                                    <circle cx="200" cy="60" r="5" fill="#ef4444" />
                                    @((MarkupString)$"<text x=\"215\" y=\"65\" font-size=\"12\" fill=\"#374151\">Stock Out</text>")

                                    <!-- Date Labels -->
                                    @for (int i = 0; i < inventoryMovementData.Count; i++)
                                    {
                                        var x = 80 + (i * (840 / Math.Max(1, inventoryMovementData.Count - 1)));
                                        var label = inventoryMovementData[i].Date.ToString("MM/dd");
                                        @((MarkupString)$"<text x=\"{x}\" y=\"400\" font-size=\"11\" fill=\"#666\" text-anchor=\"middle\">{label}</text>")
                                    }
                                </svg>
                            }
                            else
                            {
                                <div class="no-chart-data">
                                    <i class="fas fa-chart-line"></i>
                                    <p>No stock movement data available.</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- Recent Activity Section -->
            @if (IsAdministrator() || IsCashier())
            {
                <div class="activity-section">
                    <div class="activity-grid">
                        <!-- Recent Sales -->
                        <div class="activity-card">
                            <div class="activity-header">
                                <h3>Recent Sales</h3>
                                <a href="/sales-history" class="view-all-link">View All</a>
                            </div>
                            <div class="activity-list">
                                @if (recentSales.Any())
                                {
                                    @foreach (var sale in recentSales.Take(5))
                                    {
                                        <div class="activity-item">
                                            <div class="activity-icon sales-icon">
                                                <i class="fas fa-receipt"></i>
                                            </div>
                                            <div class="activity-content">
                                                <div class="activity-title">@sale.sales_order_number</div>
                                                <div class="activity-meta">@sale.sales_date.ToString("MM/dd/yyyy HH:mm")</div>
                                            </div>
                                            <div class="activity-amount">₱@sale.total_amount.ToString("N2")</div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="no-activity">
                                        <p>No recent sales</p>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </main>
</div>

@code {
    // Statistics data - Administrator
    private int totalUsers = 0;
    private int totalProducts = 0;
    private int totalSuppliers = 0;
    private int activeSuppliers = 0;
    private int pendingOrders = 0;
    private int deliveredOrders = 0;
    private decimal todaySales = 0;
    private int todayTransactions = 0;
    private decimal monthlySales = 0;
    private int monthlyTransactions = 0;

    // Statistics data - Cashier
    private decimal cashierTodaySales = 0;
    private int cashierTodayTransactions = 0;
    private decimal cashierWeeklySales = 0;
    private int cashierWeeklyTransactions = 0;

    // Statistics data - Inventory Manager
    private int lowStockProducts = 0;
    private int outOfStockProducts = 0;
    private int todayStockIn = 0;
    private int todayStockOut = 0;
    private int inventoryPendingPOs = 0;

    // Statistics data - Accountant
    private decimal totalRevenue = 0;
    private decimal totalExpenses = 0;
    private decimal netProfit = 0;
    private decimal accountsPayableTotal = 0;

    // Chart data - Sales Analytics (Admin & Accountant)
    private DateTime chartStartDate = DateTime.Now.AddDays(-90).Date;
    private DateTime chartEndDate = DateTime.Now.Date;
    private List<ChartDataPoint> chartDataPoints = new List<ChartDataPoint>();
    private List<string> chartPathPoints = new List<string>();
    private List<ChartGridLine> chartGridLines = new List<ChartGridLine>();
    private List<ChartPointData> chartPointData = new List<ChartPointData>();
    private decimal chartMinAmount = 0;
    private decimal chartMaxAmount = 0;
    private decimal chartTotalRevenue = 0;
    private decimal chartAverageDaily = 0;
    private int chartTransactionCount = 0;

    // Chart data - Cashier (Daily Sales)
    private List<DailySalesPoint> cashierDailySalesData = new List<DailySalesPoint>();
    private List<string> cashierBarChartPoints = new List<string>();
    private List<ChartGridLine> cashierGridLines = new List<ChartGridLine>();
    private decimal cashierChartMax = 0;

    // Chart data - Inventory Manager (Stock Movements)
    private List<StockMovementPoint> inventoryMovementData = new List<StockMovementPoint>();
    private List<string> inventoryStockInPoints = new List<string>();
    private List<string> inventoryStockOutPoints = new List<string>();
    private int inventoryChartMax = 0;

    // Chart data - Accountant (Revenue vs Expenses)
    private List<RevenueExpensePoint> accountantChartData = new List<RevenueExpensePoint>();
    private List<string> accountantRevenuePoints = new List<string>();
    private List<string> accountantExpensePoints = new List<string>();
    private decimal accountantChartMax = 0;

    // Recent activity
    private List<SalesOrder> recentSales = new List<SalesOrder>();

    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/");
            return;
        }

        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        isLoading = true;
        try
        {
            // Load users
            var users = await UserService.GetUsersAsync();
            totalUsers = users.Count;

            // Load products
            var products = await ProductService.GetProductsAsync();
            totalProducts = products.Count;

            // Load suppliers
            var suppliers = await SupplierService.GetSuppliersAsync();
            totalSuppliers = suppliers.Count;
            activeSuppliers = suppliers.Count(s => s.is_active == true);

            // Load purchase orders
            var purchaseOrders = await PurchaseOrderService.GetAllPurchaseOrdersAsync();
            pendingOrders = purchaseOrders.Count(po => po.status == "Pending");
            var thisMonth = DateTime.Now.AddDays(-DateTime.Now.Day + 1);
            deliveredOrders = purchaseOrders.Count(po => po.status == "Delivered" && po.order_date >= thisMonth);

            // Load sales orders
            var salesOrders = await SalesOrderService.GetAllSalesOrdersAsync();

            // Today's sales
            var today = DateTime.Now.Date;
            var todaySalesList = salesOrders.Where(s => s.sales_date.Date == today).ToList();
            todaySales = todaySalesList.Sum(s => s.total_amount);
            todayTransactions = todaySalesList.Count;

            // This month's sales
            var thisMonthStart = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
            var monthlySalesList = salesOrders.Where(s => s.sales_date >= thisMonthStart).ToList();
            monthlySales = monthlySalesList.Sum(s => s.total_amount);
            monthlyTransactions = monthlySalesList.Count;

            // Recent sales (last 5)
            recentSales = salesOrders.OrderByDescending(s => s.sales_date).Take(5).ToList();

            // Load role-specific data
            if (IsCashier())
            {
                await LoadCashierData(salesOrders);
            }
            else if (IsInventoryManager())
            {
                await LoadInventoryManagerData();
            }
            else if (IsAccountant())
            {
                await LoadAccountantData();
            }

            // Load role-specific chart data
            if (IsAdministrator())
            {
                await LoadChartData(); // Sales Analytics
            }
            else if (IsCashier())
            {
                await LoadCashierChartData(salesOrders); // Daily sales trends
            }
            else if (IsInventoryManager())
            {
                await LoadInventoryChartData(); // Stock movements and inventory levels
            }
            else if (IsAccountant())
            {
                await LoadChartData(); // Sales Analytics
                await LoadAccountantChartData(); // Revenue vs Expenses
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadChartData()
    {
        try
        {
            var startDate = chartStartDate.Date;
            var endDate = chartEndDate.Date;

            if (startDate > endDate)
            {
                // Swap dates if start is after end
                var temp = startDate;
                startDate = endDate;
                endDate = temp;
                chartStartDate = startDate;
                chartEndDate = endDate;
            }

            var salesOrders = await SalesOrderService.GetAllSalesOrdersAsync();
            var filteredSales = salesOrders.Where(s => s.sales_date.Date >= startDate && s.sales_date.Date <= endDate).ToList();

            // Group by date
            var grouped = filteredSales
                .GroupBy(s => s.sales_date.Date)
                .Select(g => new ChartDataPoint
                {
                    Date = g.Key,
                    Amount = g.Sum(s => s.total_amount),
                    Count = g.Count()
                })
                .OrderBy(c => c.Date)
                .ToList();

            chartDataPoints = grouped;
            chartTotalRevenue = filteredSales.Sum(s => s.total_amount);
            chartTransactionCount = filteredSales.Count;
            chartAverageDaily = grouped.Any() ? grouped.Average(c => c.Amount) : 0;

            // Calculate chart path points and grid lines
            if (grouped.Any())
            {
                chartMinAmount = grouped.Min(c => c.Amount);
                chartMaxAmount = grouped.Max(c => c.Amount);
                var range = chartMaxAmount - chartMinAmount;
                if (range == 0) range = 1;

                var chartHeight = 330;
                var chartWidth = 840;
                var padding = 80;
                var pointCount = grouped.Count;
                var pointSpacing = pointCount > 1 ? (chartWidth) / (pointCount - 1) : 0;

                // Generate grid lines
                chartGridLines.Clear();
                for (int i = 1; i <= 5; i++)
                {
                    var y = 50 + (i * 66);
                    var labelValue = chartMinAmount + (range * ((decimal)i / 5));
                    chartGridLines.Add(new ChartGridLine
                    {
                        Y = y,
                        Label = $"₱{(labelValue / 1000):F0}k"
                    });
                }

                // Generate path points and point data
                chartPathPoints.Clear();
                chartPointData.Clear();
                for (int i = 0; i < grouped.Count; i++)
                {
                    var x = (double)(padding + (i * pointSpacing));
                    var normalizedAmount = range > 0 ? (grouped[i].Amount - chartMinAmount) / range : 0;
                    var y = (double)(380 - (normalizedAmount * chartHeight));
                    chartPathPoints.Add($"{x},{y}");

                    chartPointData.Add(new ChartPointData
                    {
                        X = x,
                        Y = y,
                        Label = grouped[i].Date.ToString("MM/dd")
                    });
                }
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading chart data: {ex.Message}");
        }
    }

    private async Task OnStartDateChanged(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out var date))
        {
            chartStartDate = date.Date;
            if (chartStartDate > chartEndDate)
            {
                chartEndDate = chartStartDate;
            }
        }
    }

    private async Task OnEndDateChanged(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out var date))
        {
            chartEndDate = date.Date;
            if (chartStartDate > chartEndDate)
            {
                chartStartDate = chartEndDate;
            }
        }
    }

    private class ChartDataPoint
    {
        public DateTime Date { get; set; }
        public decimal Amount { get; set; }
        public int Count { get; set; }
    }

    private class ChartGridLine
    {
        public int Y { get; set; }
        public string Label { get; set; } = string.Empty;
    }

    private class ChartPointData
    {
        public double X { get; set; }
        public double Y { get; set; }
        public string Label { get; set; } = string.Empty;
    }

    private class DailySalesPoint
    {
        public DateTime Date { get; set; }
        public decimal Amount { get; set; }
        public int Count { get; set; }
    }

    private class StockMovementPoint
    {
        public DateTime Date { get; set; }
        public int StockIn { get; set; }
        public int StockOut { get; set; }
    }

    private class RevenueExpensePoint
    {
        public DateTime Date { get; set; }
        public decimal Revenue { get; set; }
        public decimal Expenses { get; set; }
    }

    // Role checking methods
    private bool IsAdministrator()
    {
        return AuthService.CurrentUserRoleName?.Equals("Administrator", StringComparison.OrdinalIgnoreCase) ?? false;
    }

    private bool IsCashier()
    {
        return AuthService.CurrentUserRoleName?.Equals("Cashier", StringComparison.OrdinalIgnoreCase) ?? false;
    }

    private bool IsInventoryManager()
    {
        return AuthService.CurrentUserRoleName?.Equals("Inventory Manager", StringComparison.OrdinalIgnoreCase) ?? false;
    }

    private bool IsAccountant()
    {
        return AuthService.CurrentUserRoleName?.Equals("Accountant", StringComparison.OrdinalIgnoreCase) ?? false;
    }

    // Role-specific data loading methods
    private async Task LoadCashierData(List<SalesOrder> allSalesOrders)
    {
        try
        {
            var today = DateTime.Now.Date;
            var weekStart = today.AddDays(-(int)today.DayOfWeek);

            // Today's sales
            var todaySalesList = allSalesOrders.Where(s => s.sales_date.Date == today).ToList();
            cashierTodaySales = todaySalesList.Sum(s => s.total_amount);
            cashierTodayTransactions = todaySalesList.Count;

            // Weekly sales (last 7 days)
            var weeklySalesList = allSalesOrders.Where(s => s.sales_date.Date >= weekStart && s.sales_date.Date <= today).ToList();
            cashierWeeklySales = weeklySalesList.Sum(s => s.total_amount);
            cashierWeeklyTransactions = weeklySalesList.Count;

            // Recent sales for cashier
            recentSales = allSalesOrders.OrderByDescending(s => s.sales_date).Take(5).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading cashier data: {ex.Message}");
        }
    }

    private async Task LoadInventoryManagerData()
    {
        try
        {
            var products = await ProductService.GetProductsAsync();
            lowStockProducts = products.Count(p => (p.quantity ?? 0) > 0 && (p.quantity ?? 0) < 10);
            outOfStockProducts = products.Count(p => (p.quantity ?? 0) == 0);

            var today = DateTime.Now.Date;

            // Today's stock movements
            var stockIns = await StockInService.GetStockInHistoryAsync();
            var todayStockIns = stockIns.Where(s => s.stock_in_date.Date == today).ToList();
            todayStockIn = todayStockIns.Count;

            var stockOuts = await StockOutService.GetStockOutHistoryAsync();
            var todayStockOuts = stockOuts.Where(s => s.stock_out_date.Date == today).ToList();
            todayStockOut = todayStockOuts.Count;

            // Pending purchase orders
            var purchaseOrders = await PurchaseOrderService.GetAllPurchaseOrdersAsync();
            inventoryPendingPOs = purchaseOrders.Count(po => po.status == "Pending");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading inventory manager data: {ex.Message}");
        }
    }

    private async Task LoadAccountantData()
    {
        try
        {
            var salesOrders = await SalesOrderService.GetAllSalesOrdersAsync();
            totalRevenue = salesOrders.Sum(s => s.total_amount);

            var expenses = await ExpenseService.GetExpensesAsync();
            totalExpenses = expenses.Sum(e => e.amount);

            netProfit = totalRevenue - totalExpenses;

            var accountsPayable = await AccountsPayableService.GetAccountsPayableAsync();
            accountsPayableTotal = accountsPayable.Where(ap => ap.status == "Unpaid" || ap.status == "Partial").Sum(ap => ap.balance_amount);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading accountant data: {ex.Message}");
        }
    }

    // Cashier Chart: Daily Sales (Last 7 Days)
    private async Task LoadCashierChartData(List<SalesOrder> allSalesOrders)
    {
        try
        {
            var last7Days = Enumerable.Range(0, 7)
                .Select(i => DateTime.Now.Date.AddDays(-i))
                .Reverse()
                .ToList();

            cashierDailySalesData = last7Days.Select(date =>
            {
                var daySales = allSalesOrders.Where(s => s.sales_date.Date == date).ToList();
                return new DailySalesPoint
                {
                    Date = date,
                    Amount = daySales.Sum(s => s.total_amount),
                    Count = daySales.Count
                };
            }).ToList();

            if (cashierDailySalesData.Any())
            {
                cashierChartMax = cashierDailySalesData.Max(d => d.Amount);
                if (cashierChartMax == 0) cashierChartMax = 1000; // Default max if no sales
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading cashier chart data: {ex.Message}");
        }
    }

    // Inventory Manager Chart: Stock Movements (Last 7 Days)
    private async Task LoadInventoryChartData()
    {
        try
        {
            var last7Days = Enumerable.Range(0, 7)
                .Select(i => DateTime.Now.Date.AddDays(-i))
                .Reverse()
                .ToList();

            var stockIns = await StockInService.GetStockInHistoryAsync();
            var stockOuts = await StockOutService.GetStockOutHistoryAsync();

            // Pre-load all stock in items
            var allStockInItems = new Dictionary<int, int>();
            foreach (var stockIn in stockIns.Where(s => last7Days.Contains(s.stock_in_date.Date)))
            {
                var items = await StockInService.GetStockInItemsAsync(stockIn.stock_in_id);
                allStockInItems[stockIn.stock_in_id] = items.Sum(i => i.quantity_received);
            }

            // Pre-load all stock out items
            var allStockOutItems = new Dictionary<int, int>();
            foreach (var stockOut in stockOuts.Where(s => last7Days.Contains(s.stock_out_date.Date)))
            {
                var items = await StockOutService.GetStockOutItemsAsync(stockOut.stock_out_id);
                allStockOutItems[stockOut.stock_out_id] = items.Sum(i => i.quantity);
            }

            inventoryMovementData = last7Days.Select(date =>
            {
                var dayStockIns = stockIns.Where(s => s.stock_in_date.Date == date).ToList();
                var dayStockOuts = stockOuts.Where(s => s.stock_out_date.Date == date).ToList();

                int stockInQty = dayStockIns.Sum(si => allStockInItems.ContainsKey(si.stock_in_id) ? allStockInItems[si.stock_in_id] : 0);
                int stockOutQty = dayStockOuts.Sum(so => allStockOutItems.ContainsKey(so.stock_out_id) ? allStockOutItems[so.stock_out_id] : 0);

                return new StockMovementPoint
                {
                    Date = date,
                    StockIn = stockInQty,
                    StockOut = stockOutQty
                };
            }).ToList();

            if (inventoryMovementData.Any())
            {
                inventoryChartMax = Math.Max(
                    inventoryMovementData.Max(m => m.StockIn),
                    inventoryMovementData.Max(m => m.StockOut)
                );
                if (inventoryChartMax == 0) inventoryChartMax = 10; // Default max

                // Generate chart points
                var chartHeight = 330;
                var chartWidth = 840;
                var padding = 80;
                var pointCount = inventoryMovementData.Count;
                var pointSpacing = pointCount > 1 ? (double)chartWidth / (pointCount - 1) : 0;

                inventoryStockInPoints.Clear();
                inventoryStockOutPoints.Clear();

                for (int i = 0; i < inventoryMovementData.Count; i++)
                {
                    var x = padding + (i * pointSpacing);
                    
                    var stockInY = inventoryChartMax > 0 
                        ? 380 - ((double)inventoryMovementData[i].StockIn / inventoryChartMax * chartHeight)
                        : 380;
                    inventoryStockInPoints.Add($"{x},{stockInY}");

                    var stockOutY = inventoryChartMax > 0
                        ? 380 - ((double)inventoryMovementData[i].StockOut / inventoryChartMax * chartHeight)
                        : 380;
                    inventoryStockOutPoints.Add($"{x},{stockOutY}");
                }
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading inventory chart data: {ex.Message}");
        }
    }

    // Accountant Chart: Revenue vs Expenses (Last 6 Months)
    private async Task LoadAccountantChartData()
    {
        try
        {
            var salesOrders = await SalesOrderService.GetAllSalesOrdersAsync();
            var expenses = await ExpenseService.GetExpensesAsync();

            var last6Months = Enumerable.Range(0, 6)
                .Select(i => new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1).AddMonths(-i))
                .Reverse()
                .ToList();

            accountantChartData = last6Months.Select(monthStart =>
            {
                var monthEnd = monthStart.AddMonths(1).AddDays(-1);
                var monthSales = salesOrders
                    .Where(s => s.sales_date.Date >= monthStart && s.sales_date.Date <= monthEnd)
                    .Sum(s => s.total_amount);
                var monthExpenses = expenses
                    .Where(e => e.expense_date.Date >= monthStart && e.expense_date.Date <= monthEnd)
                    .Sum(e => e.amount);

                return new RevenueExpensePoint
                {
                    Date = monthStart,
                    Revenue = monthSales,
                    Expenses = monthExpenses
                };
            }).ToList();

            if (accountantChartData.Any())
            {
                accountantChartMax = Math.Max(
                    accountantChartData.Max(d => d.Revenue),
                    accountantChartData.Max(d => d.Expenses)
                );
                if (accountantChartMax == 0) accountantChartMax = 1000;

                // Generate chart points
                var chartHeight = 330;
                var chartWidth = 840;
                var padding = 80;
                var pointCount = accountantChartData.Count;
                var pointSpacing = pointCount > 1 ? (double)chartWidth / (pointCount - 1) : 0;

                accountantRevenuePoints.Clear();
                accountantExpensePoints.Clear();

                for (int i = 0; i < accountantChartData.Count; i++)
                {
                    var x = padding + (i * pointSpacing);
                    
                    var revenueY = accountantChartMax > 0
                        ? 380 - ((double)(accountantChartData[i].Revenue / accountantChartMax) * chartHeight)
                        : 380;
                    accountantRevenuePoints.Add($"{x},{revenueY}");

                    var expenseY = accountantChartMax > 0
                        ? 380 - ((double)(accountantChartData[i].Expenses / accountantChartMax) * chartHeight)
                        : 380;
                    accountantExpensePoints.Add($"{x},{expenseY}");
                }
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading accountant chart data: {ex.Message}");
        }
    }

}